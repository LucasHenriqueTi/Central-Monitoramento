# üöÄ Central de Observabilidade (Stack OTel + LGTM)

Este reposit√≥rio cont√©m uma stack de observabilidade completa e centralizada, pronta para monitorar m√∫ltiplas aplica√ß√µes. A arquitetura √© baseada no padr√£o OTel (OpenTelemetry) e na "LGTM Stack" (Loki, Grafana, Tempo, Mimir/Prometheus).

O objetivo √© ter um **√∫nico local** que recebe, armazena e visualiza:
* **M√©tricas** (Prometheus)
* **Logs** (Loki)
* **Traces** (Tempo)

## üèõÔ∏è Arquitetura da Solu√ß√£o

Esta stack √© composta por 6 servi√ßos principais orquestrados via `docker-compose.yml`:

1.  **Grafana:** A plataforma de visualiza√ß√£o e dashboard onde voc√™ ver√° todos os seus dados.
2.  **Prometheus:** O banco de dados de s√©ries temporais para armazenar **M√©tricas**.
3.  **Loki:** O sistema de armazenamento para **Logs**.
4.  **Tempo:** O sistema de armazenamento para **Traces** (rastreamentos).
5.  **Promtail:** O agente coletor de logs para **Infraestrutura**. Ele "assiste" os logs do Docker e os envia para o Loki.
6.  **OTel Collector (Contrib):** O "porteiro" principal para suas **Aplica√ß√µes**. Ele recebe telemetria (logs, traces, m√©tricas) via protocolo OTLP e os distribui para o destino correto (Loki, Tempo ou Prometheus).

## ‚öôÔ∏è Estrutura de Arquivos

## ‚ñ∂Ô∏è Como Executar

**Pr√©-requisitos:**
* Docker
* Docker Compose

1.  Clone este reposit√≥rio.
2.  Navegue at√© a pasta raiz do projeto no seu terminal.
3.  Execute o comando para iniciar todos os servi√ßos em segundo plano:
    ```bash
    docker-compose up -d
    ```
4.  Para parar todos os servi√ßos, execute:
    ```bash
    docker-compose down
    ```

## üîå Acessando os Servi√ßos

Uma vez que os containers est√£o no ar (`up`), voc√™ pode acessar as interfaces:

* **üñ•Ô∏è Grafana (Painel Principal):**
    * **URL:** `http://localhost:3000`
    * **Login:** `admin` / `admin` (ser√° solicitado trocar a senha no primeiro acesso)

* **üéØ Prometheus (M√©tricas):**
    * **URL:** `http://localhost:9090`

* **üìÑ Loki (Logs):**
    * **URL:** `http://localhost:3100`

* **üìç OTel Collector (Ponto de Entrada para Apps):**
    * **URL (HTTP):** `http://localhost:14318`
    * *Este √© o endere√ßo que suas aplica√ß√µes (frontend/backend) devem usar para enviar dados OTLP.*

### Configura√ß√£o Inicial do Grafana (Data Sources)

Ap√≥s o primeiro login no Grafana, voc√™ precisa conectar as fontes de dados.

1.  Acesse `http://localhost:3000`.
2.  No menu lateral (‚öôÔ∏è), v√° em **"Connections"** > **"Data Sources"**.
3.  Clique em **"Add new data source"** para cada um dos servi√ßos abaixo.

> **IMPORTANTE:** Como o Grafana est√° rodando dentro da mesma rede Docker Compose, use o **nome do servi√ßo** (ex: `http://loki:3100`), e n√£o `localhost`.

* **Fonte 1: Prometheus**
    * **Tipo:** `Prometheus`
    * **URL:** `http://prometheus:9090`
    * Clique em "Save & Test".

* **Fonte 2: Loki**
    * **Tipo:** `Loki`
    * **URL:** `http://loki:3100`
    * Clique em "Save & Test".

* **Fonte 3: Tempo**
    * **Tipo:** `Tempo`
    * **URL:** `http://tempo:3200`
    * Clique em "Save & Test".

## ‚ö†Ô∏è Observa√ß√µes e Pontos de Aten√ß√£o (Troubleshooting)

Chegar a esta configura√ß√£o est√°vel exigiu a observa√ß√£o de alguns pontos cruciais:

1.  **Erro `no such file or directory` (Configura√ß√£o de Volumes):**
    * **Problema:** Os containers `tempo` ou `otel-collector` falhavam ao iniciar com um erro de "arquivo n√£o encontrado".
    * **Causa:** No arquivo `docker-compose.yml`, o caminho na diretiva `command:` (que diz ao container qual arquivo ler) e o caminho de destino na diretiva `volumes:` (que "injeta" o arquivo) n√£o eram id√™nticos.
    * **Solu√ß√£o:** Garanta que os caminhos s√£o os mesmos.
        *Exemplo (Tempo):*
        ```yaml
        command: [-config.file=/etc/tempo.yml]  # <-- Este caminho
        volumes:
          - ./tempo/tempo-config.yml:/etc/tempo.yml # <-- Deve ser id√™ntico a este
        ```

2.  **Erro `yaml: unmarshal errors` (Configura√ß√£o do Tempo):**
    * **Problema:** O container `tempo` iniciava, mas falhava ao ler o `tempo-config.yml` devido a um erro de formato.
    * **Causa:** A imagem `grafana/tempo:latest` mudou. Campos de configura√ß√£o (como `ingester:`) podem se tornar obsoletos ou ter a indenta√ß√£o incorreta.
    * **Solu√ß√£o:** Simplificamos o `tempo-config.yml` (removendo o bloco `ingester` e corrigindo a indenta√ß√£o do `storage.local.path`) para usar os padr√µes da nova vers√£o.

3.  **Erro de "Ciclo de Rein√≠cio" (`received SIGINT/SIGTERM`):**
    * **Problema:** O container `tempo` subia com sucesso, mas era "desligado" (via `SIGTERM`) ap√≥s alguns segundos, entrando em um loop de reinicializa√ß√£o.
    * **Causa:** O `tempo` estava saud√°vel, mas o `otel-collector`, que tinha um `depends_on: [tempo]`, estava falhando ao iniciar (crashando). O Docker Compose, ao ver o `otel-collector` falhar, desligava os servi√ßos relacionados (incluindo o `tempo`) para tentar reiniciar a stack.
    * **Li√ß√£o:** Se um container "saud√°vel" continua reiniciando, **verifique os logs dos containers que dependem dele**.

4.  **Exportador Loki no OTel Collector (A Mudan√ßa Cr√≠tica):**
    * **Problema:** O `otel-collector` falhava ao tentar usar o exportador `loki:`.
    * **Causa:** A imagem `otel/opentelemetry-collector-contrib:latest` removeu o exportador `loki` nativo.
    * **Solu√ß√£o (Correta):** O Loki agora aceita dados diretamente via OTLP. A configura√ß√£o correta no `otel-config.yml` √© usar o exportador `otlphttp:` apontando para o endpoint OTLP do Loki.
        *No `otel-config.yml` (se√ß√£o `exporters`):*
        ```yaml
        exporters:
          otlphttp/loki:
            endpoint: "http://loki:3100/otlp"
        ```
        *E na pipeline de logs:*
        ```yaml
        logs:
          receivers: [otlp]
          processors: [batch]
          exporters: [otlphttp/loki] # <-- Usando o novo exportador
        ```